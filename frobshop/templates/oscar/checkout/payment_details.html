{% extends "oscar/checkout/checkout.html" %}
{% load i18n %}
{% load currency_filters %}  {# Don't forget to load the currency_filters if you want to display prices %}

{% block title %}
    {% trans "Payment details" %} | {{ block.super }}
{% endblock %}

{% block checkout_nav %}
    {% include 'oscar/checkout/nav.html' with step=3 %}
{% endblock %}

{% block checkout_title %}{% trans "Enter payment details" %}{% endblock %}

{% block order_contents %}{% endblock %}
{% block shipping_address %}{% endblock %}
{% block shipping_method %}{% endblock %}
{% block payment_method %}{% endblock %}

{% block payment_details %}
<head xmlns="http://www.w3.org/1999/html">
   <meta name="viewport" content="width=device-width, initial-scale=1" />
     <style>
     *,@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');


    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #C1BFFA;
      font-family: inter, sans-serif;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 30px;
      padding-bottom: 30px;

      margin-top: 50px;
      margin-bottom: 80px;

      position: relative;
      width: fit-content;
      height: fit-content;
      border-radius: 16px;
      background-color: white;

      border: 2px solid #1B1B1B;
      box-sizing: border-box;
      box-shadow: 6px 6px 0px #1B1B1B;
      border-radius: 8px;
    }

    .heading {
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    #exit {
      align-self: flex-end;
    }

    h1 {
      margin-left: 10px;
      font-size: 2rem;
      font-weight: 800;
    }

    label {
      font-weight: 600;
    }

    input {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      margin-top: 10px;
      padding: 16px 24px;
      width: 90%;
      height: 15%;
      left: 1048px;
      top: 16px;
      background: #FFFFFF;
      border: 2px solid #1B1B1B;
      box-sizing: border-box;
      border-radius: 16px;
      transition: 0.2s;
    }

    textarea:focus, input:focus{
      outline: none;
      background: #F9E450;
      border: 3px solid #1B1B1B;
      border-radius: 16px;
    }

    .exp-cvc {
      justify-self: center;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 90%;
    }

    .expiration {
      font-size: 0.75rem;
      width: 50%;
      margin-right: 20px;
    }

    .security {
      font-size: 0.75rem;
      width: 50%;
      margin-left: 20px;
    }

    span {
      padding-left: 5px;
      cursor: pointer;
    }

    .btn {
      background-color: #F9E450;
      border: 2px solid #1B1B1B;
      box-sizing: border-box;
      border-radius: 16px;
      padding: 16px 32px 16px 16px;
      text-align: center;
      font-weight: 800;
      margin-top: 20px;

      width: 141px;
      height: 56px;
      left: 16px;
      top: 88px;

      display: flex;
      flex-direction: row;
      align-items: center;
      align-self: flex-end;
      cursor: pointer;
      transition: 0.16s ease-out;
    }

    .btn:hover {
      background: #FFBB38;
      border: 4px solid #1B1B1B;
      box-sizing: border-box;
      box-shadow: 0px 0px 0px 4px #C1BFFA;
      border-radius: 16px;
    }

    #exit {
      cursor: pointer;
    }
    header.header.container {
    width: 82%;
}
</style>
    <style>input#phone{
        position: static;
        }</style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

</head>

<body>
            <h2>Booking for  {{ request.basket.all_lines.0.product.parent.title }}</h2>
            {# Here we iterate over the lines in the basket #}
            {% for line in request.basket.all_lines %}
                <p id="product_name">Product Name: {{ line.product.title }}</p>
                <p>Room Price: {{ line.line_price_incl_tax|currency }}</p>
            {% endfor %}


            <form action="{% url 'handle_payment' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="offer_id" value="{{ offer_id }}">
                <p>Title:
                    <select name="title" required>
                        <option value="">Select...</option>
                        <option value="Mr">Mr</option>
                        <option value="Mrs">Mrs</option>
                        <option value="Ms">Ms</option>
                    </select>
                </p>
                <p>First Name: <input type="text" name="first_name" required></p>
                <p>Last Name: <input type="text" name="last_name" required></p>
                <p>Enter your phone number:</p>
                <input id="phone" type="tel" name="phone">
                </br>
                </br>

                <p>Email: <input type="email" name="email" required></p>
                <p>Payment Method:
                    <select name="method" required>
                        <option value="">Select...</option>
                        <option value="CreditCard">Credit Card</option>
                    </select>
                </p>
                <p>Card Vendor Code:
                    <select name="vendor_code" required>
                        <option value="">Select...</option>
                        <option value="VI"> Visa</option>
                        <option value="MC">MASTER CARD</option>
                        <option value="AX">AMERICAN EXPRESS</option>
                    </select>
                </p>
                <p>Card Number: <input type="text" minlength="15" maxlength="16" class="card-number" name="card_number" placeholder="Card Number" required></p>
                <p>Card Expiry Date: <input type="month" id="expiry_date" name="expiry_date" required></p>
                <input type="submit" id="view_preview" class="btn btn-primary btn-lg" value="{% trans 'Continue' %}">
                <p class="error-msg" style="color:red;"></p>

            </form>
            <div class="alert alert-info" style="display: none;"></div>

        </body>
        <script>
                    let form = document.querySelector('form');
                    let continueButton = document.getElementById('view_preview');

                    form.addEventListener('input', function() {
                        let fields = form.querySelectorAll('input[required]');
                        let allFilled = Array.from(fields).every(function(field) {
                            return field.value !== '';
                        });

                        continueButton.disabled = !allFilled;
                    });
                </script>
        <script>
            let expiryDateInput = document.getElementById('expiry_date');

            expiryDateInput.min = new Date().toISOString().substring(0,7);

            expiryDateInput.addEventListener('input', function() {
                let chosenDate = new Date(this.value + '-01');
                let now = new Date();

                if (chosenDate < now) {
                    this.setCustomValidity('Expiry date cannot be in the past');
                } else {
                    this.setCustomValidity('');
                }
            });
        </script>
        <script>
            function luhnCheck(val) {
            let sum = 0;
            for (let i = 0; i < val.length; i++) {
                let intVal = parseInt(val.substr(i, 1));
                if (i % 2 == 0) {
                    intVal *= 2;
                    if (intVal > 9) {
                        intVal = 1 + (intVal % 10);
                    }
                }
                sum += intVal;
            }
            return (sum % 10) == 0;
        }

        document.querySelector('form').addEventListener('submit', function(e){
            let cardNumber = document.querySelector('.card-number').value;
            if(!luhnCheck(cardNumber)){
                alert('Invalid Card Number');
                e.preventDefault();
            }
        });

        </script>
        <script>
            function updateProductName() {
            // Select the paragraph element by id
            let productTitleElement = document.getElementById("product_name");

            // Get the text content of the paragraph
            let productTitle = productTitleElement.textContent;

            // Find the index of the first comma in the string
            let commaIndex = productTitle.indexOf(',');

            // If there is a comma in the string
            if(commaIndex !== -1) {
                // Take all elements before the first comma
                let productName = productTitle.slice(commaIndex+1);

                // Update the text content of the paragraph
                productTitleElement.textContent = productName;
            }
        }

        // Call the function
        updateProductName();


        </script>
        <script>
            const phoneInputField = document.querySelector("#phone");
            const phoneInput = window.intlTelInput(phoneInputField, {
                utilsScript:
                    "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
                    // allowDropdown: false,
                        // autoHideDialCode: false,
                        // autoPlaceholder: "off",
                        // dropdownContainer: document.body,
                        // excludeCountries: ["us"],
                        // formatOnDisplay: false,
                        // geoIpLookup: function(callback) {
                        //   $.get("http://ipinfo.io", function() {}, "jsonp").always(function(resp) {
                        //     var countryCode = (resp && resp.country) ? resp.country : "";
                        //     callback(countryCode);
                        //   });
                        // },
                        // hiddenInput: "full_number",
                        initialCountry: "auto",
                        // localizedCountries: { 'de': 'Deutschland' },
                        // nationalMode: false,
                        //onlyCountries: ['us', 'gb', 'ch', 'ca', 'do'],
                        // placeholderNumberType: "MOBILE",
                        preferredCountries: ['il','us', 'gb', 'ch', 'ca', 'do'],
                        separateDialCode: true,
            });

            document.querySelector('form').addEventListener('submit', function(e) {
                if(!phoneInput.isValidNumber()) {
                    alert('Invalid Phone Number');
                    e.preventDefault();
                }
            });
        </script>


{% endblock payment_details %}
